<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Convert TXT to JSON</title>
<style>
  body { font-family: monospace; padding: 20px; }
  pre { white-space: pre-wrap; word-wrap: break-word; }
</style>
</head>
<body>

<h2>Convertir text.txt → gr.json</h2>
<input type="file" id="fileInput">
<pre id="output"></pre>

<script>
document.getElementById("fileInput").addEventListener("change", function(e) {

  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();

  reader.onload = function() {

    const raw = reader.result
      .replace(/\r\n/g, "\n")
      .replace(/\u2028|\u2029/g, "\n")
      .trim();

    // Detecta capítulos Y hablantes en orden secuencial
    const tokenRegex = /\[(\d+)\]|(Μένιππος|Ἕταιρος):--/g;

    let chapters = [];
    let currentChapter = null;
    let currentSpeaker = null;
    let buffer = "";
    let unitCounter = 1;

    function flushBuffer() {
      if (!buffer.trim() || !currentChapter || !currentSpeaker) return;

      const clean = buffer
        .replace(/\n+/g, " ")
        .replace(/\s+/g, " ")
        .trim();

      const sentences = clean.match(/[^.;·:]+[.;·:]?/g);
      if (!sentences) return;

      for (let sentence of sentences) {
        const text = sentence.trim();
        if (!text) continue;

        currentChapter.units.push({
          id: `${currentChapter.id}.${unitCounter++}`,
          speaker: currentSpeaker,
          text: text
        });
      }

      buffer = "";
    }

    let match;
    let lastIndex = 0;

    while ((match = tokenRegex.exec(raw)) !== null) {

      // texto entre tokens
      buffer += raw.slice(lastIndex, match.index);
      lastIndex = tokenRegex.lastIndex;

      // Si encontramos capítulo
      if (match[1]) {
        flushBuffer();

        const chapterId = parseInt(match[1]);

        currentChapter = {
          id: chapterId,
          units: []
        };

        chapters.push(currentChapter);
        unitCounter = 1;

        continue;
      }

      // Si encontramos hablante
      if (match[2]) {
        flushBuffer();
        currentSpeaker = match[2];
        continue;
      }
    }

    // Flush final
    buffer += raw.slice(lastIndex);
    flushBuffer();

    const json = JSON.stringify({ chapters }, null, 2);
    document.getElementById("output").textContent = json;
  };

  reader.readAsText(file);
});
</script>

</body>
</html>